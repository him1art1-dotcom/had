<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>حاضر | بوابة الحضور</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <script>
      (function () {
        try {
          var storageKey = 'hader:theme';
          var defaultAccent = '#2f80ed';
          var parsed = JSON.parse(localStorage.getItem(storageKey) || '{}');
          var mode = typeof parsed.mode === 'string' ? parsed.mode : 'system';
          var accent = typeof parsed.accent === 'string' ? parsed.accent : defaultAccent;
          if (!/^#?[0-9a-fA-F]{6}$/.test(accent)) {
            accent = defaultAccent;
          }
          if (accent.charAt(0) !== '#') {
            accent = '#' + accent;
          }
          var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          var theme = mode === 'dark' || (mode === 'system' && prefersDark) ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', theme);
          document.documentElement.dataset.themeMode = mode;
          var hex = accent.slice(1);
          var r = parseInt(hex.slice(0, 2), 16);
          var g = parseInt(hex.slice(2, 4), 16);
          var b = parseInt(hex.slice(4, 6), 16);
          if (!Number.isNaN(r) && !Number.isNaN(g) && !Number.isNaN(b)) {
            document.documentElement.style.setProperty('--adm-accent', accent.toLowerCase());
            document.documentElement.style.setProperty('--adm-accent-rgb', r + ', ' + g + ', ' + b);
            var rn = r / 255;
            var gn = g / 255;
            var bn = b / 255;
            var transform = function (channel) {
              return channel <= 0.03928 ? channel / 12.92 : Math.pow((channel + 0.055) / 1.055, 2.4);
            };
            var luminance = 0.2126 * transform(rn) + 0.7152 * transform(gn) + 0.0722 * transform(bn);
            var contrast = luminance > 0.55 ? '#041124' : '#ffffff';
            document.documentElement.style.setProperty('--adm-accent-contrast', contrast);
            document.documentElement.style.setProperty('--btn-text', contrast);
            var mixComponent = function (component, target, ratio) {
              return Math.round(component + (target - component) * ratio);
            };
            var toHex = function (value) {
              var hex = value.toString(16);
              return hex.length === 1 ? '0' + hex : hex;
            };
            var mixRatio = theme === 'dark' ? 0.32 : 0.18;
            var mixTarget = theme === 'dark' ? 255 : 0;
            var mixR = mixComponent(r, mixTarget, mixRatio);
            var mixG = mixComponent(g, mixTarget, mixRatio);
            var mixB = mixComponent(b, mixTarget, mixRatio);
            document.documentElement.style.setProperty('--brand-accent', '#' + toHex(mixR) + toHex(mixG) + toHex(mixB));
            document.documentElement.style.setProperty('--brand-accent-rgb', mixR + ', ' + mixG + ', ' + mixB);
            var overlayAlpha = theme === 'dark' ? 0.28 : 0.22;
            var overlayStrongAlpha = theme === 'dark' ? 0.36 : 0.3;
            document.documentElement.style.setProperty('--surface-overlay', 'rgba(' + r + ', ' + g + ', ' + b + ', ' + overlayAlpha + ')');
            document.documentElement.style.setProperty('--surface-overlay-strong', 'rgba(' + r + ', ' + g + ', ' + b + ', ' + overlayStrongAlpha + ')');
          }
        } catch (error) {
          /* تجاهل أي أخطاء في القراءة المسبقة */
        }
      })();
    </script>
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/tokens.css" />
    <link rel="stylesheet" href="css/student.css" />
    <script defer src="./sql-wasm.js"></script>
  </head>
  <body>
    <div class="page-root">
      <div class="school-lock" data-school-lock hidden>
        <div
          class="school-lock__dialog"
          data-school-lock-dialog
          role="alertdialog"
          aria-modal="true"
          tabindex="-1"
        >
          <span class="school-lock__light" aria-hidden="true"></span>
          <div class="school-lock__content">
            <h2 class="school-lock__title">تم إيقاف المدرسة</h2>
            <p class="school-lock__message" data-school-lock-message>راجع الدعم الفني</p>
          </div>
        </div>
      </div>
      <main class="portal-screen" data-portal-root>
      <div class="portal-ad portal-ad--top" data-ad-slot="top" hidden>
        <a class="portal-ad__link" data-ad-link="top" target="_blank" rel="noopener">
          <img data-ad-image="top" alt="إعلان أعلى بوابة الحضور" />
        </a>
      </div>

      <div class="portal-controls" data-portal-controls>
        <button
          class="portal-controls__toggle"
          type="button"
          data-controls-toggle
          aria-expanded="false"
          aria-controls="portal-controls-panel"
        >
          ⚙️
        </button>
        <div class="portal-controls__panel" id="portal-controls-panel" data-controls-panel hidden>
          <div class="portal-controls__section" role="group" aria-label="إعدادات الحجم">
            <label class="portal-controls__label" for="font-scale-control">حجم الخط</label>
            <div class="portal-controls__field">
              <input
                id="font-scale-control"
                class="portal-controls__range"
                type="range"
                min="70"
                max="150"
                step="5"
                data-font-range
              />
              <span class="portal-controls__value" data-font-value>100%</span>
            </div>
            <label class="portal-controls__label" for="card-scale-control">حجم البطاقات</label>
            <div class="portal-controls__field">
              <input
                id="card-scale-control"
                class="portal-controls__range"
                type="range"
                min="60"
                max="180"
                step="5"
                data-card-range
              />
              <span class="portal-controls__value" data-card-value>100%</span>
            </div>
          </div>
          <div class="portal-controls__section" role="group" aria-label="إعدادات التموضع">
            <button class="portal-controls__drag" type="button" data-drag-toggle aria-pressed="false">
              وضع السحب
            </button>
            <p class="portal-controls__hint">فعّل الوضع ثم اسحب اللوحة لتغيير موضعها.</p>
            <dl class="portal-controls__position" aria-live="polite">
              <div>
                <dt>أفقي</dt>
                <dd><span data-position-x>0</span> بكسل</dd>
              </div>
              <div>
                <dt>رأسي</dt>
                <dd><span data-position-y>0</span> بكسل</dd>
              </div>
            </dl>
            <button class="portal-controls__reset" type="button" data-position-reset>إعادة التموضع</button>
          </div>
        </div>
      </div>

      <div class="portal-stage" data-portal-stage>
        <div class="portal-canvas" data-portal-canvas>
          <div class="kiosk-viewport" data-scale-root>
            <main class="kiosk-shell">
              <section class="kiosk-panel">
                <header class="panel-header">
                  <figure class="kiosk-banner" data-banner-wrapper hidden>
                    <img data-banner alt="صورة عرض بوابة الحضور" />
                  </figure>
                  <p class="school-badge" data-school-name hidden></p>
                  <p class="kiosk-message" data-morning-message></p>
                  <div class="clock-display" data-clock>--:--:--</div>
                </header>

                <section class="kiosk-input">
                  <label for="student-id-input">أدخل رقم الطالب أو امسح الباركود</label>
                  <input
                    id="student-id-input"
                    type="text"
                    inputmode="numeric"
                    autocomplete="off"
                    data-id-input
                    autofocus
                  />
                </section>

                <section class="kiosk-status" data-status-card hidden>
                  <header class="status-header">
                    <div class="status-identity">
                      <span class="status-badge" data-status-badge>—</span>
                      <h2 class="status-name" data-student-name>—</h2>
                      <p class="status-meta" data-student-meta></p>
                    </div>
                    <div class="status-time" data-arrival-block>
                      <span class="status-time__value" data-arrival-time>--:--:--</span>
                      <span class="status-time__label">وقت التسجيل</span>
                    </div>
                  </header>
                  <p class="status-message" data-status-message></p>
                  <div class="status-stats" data-late-stats hidden>
                    <div class="status-stat">
                      <span class="status-stat__value" data-late-days>0</span>
                      <span class="status-stat__label">أيام التأخر</span>
                    </div>
                    <div class="status-stat">
                      <span class="status-stat__value" data-late-today>0</span>
                      <span class="status-stat__label">دقائق تأخر اليوم</span>
                    </div>
                    <div class="status-stat">
                      <span class="status-stat__value" data-late-total>0</span>
                      <span class="status-stat__label">إجمالي دقائق التأخر</span>
                    </div>
                  </div>
                </section>
                <aside class="attendance-counter" data-attendance-counter hidden>
                  <h3 class="attendance-counter__title">الحضور الآن</h3>
                  <p class="attendance-counter__ratio">
                    <span class="attendance-counter__current" data-attendance-current>0</span>
                    <span class="attendance-counter__divider">/</span>
                    <span class="attendance-counter__total" data-attendance-total>0</span>
                  </p>
                  <p class="attendance-counter__hint">الحضور الحالي من إجمالي الطلاب</p>
                </aside>
              </section>

              <section class="kiosk-tip" data-general-tip hidden>
                <span class="kiosk-tip__icon" aria-hidden="true">✨</span>
                <p class="kiosk-tip__text" data-general-tip-text></p>
              </section>
            </main>
          </div>
        </div>
        <button class="portal-rotate" type="button" data-rotation-toggle aria-label="تغيير اتجاه العرض">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 5v4.5" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M4 12a8 8 0 0113.7-5.6" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M19 9v6h-6" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M20 20l-4-4" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
        <div class="kiosk-screensaver" data-screensaver hidden aria-hidden="true">
          <div class="kiosk-screensaver__content">
            <div class="kiosk-screensaver__media">
              <img data-screensaver-image alt="محتوى شاشة التوقف" hidden />
              <video data-screensaver-video muted playsinline loop hidden></video>
            </div>
            <p class="kiosk-screensaver__text" data-screensaver-text></p>
          </div>
        </div>
      </div>

      <div class="portal-ad portal-ad--bottom" data-ad-slot="bottom" hidden>
        <a class="portal-ad__link" data-ad-link="bottom" target="_blank" rel="noopener">
          <img data-ad-image="bottom" alt="إعلان أسفل بوابة الحضور" />
        </a>
      </div>
      </main>
      <footer class="site-footer" role="contentinfo">© جميع الحقوق محفوظة | أ. هيثم الزهراني | Him.Art</footer>
    </div>

    <script src="js/theme.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="./js/env.js"></script>
    <script type="module" src="js/store/backend-factory.js"></script>
    <script type="module" src="js/backend-otherrest.js"></script>
    <script type="module" src="js/backend-supabase.js"></script>
    <script type="module" src="js/storage-ls.js"></script>
    <script type="module" src="js/storage-sql.js"></script>
    <script type="module" src="js/remote-sync.js"></script>
    <script type="module" src="js/student.js"></script>
    <script type="module">
      import { registerBackend } from './js/store/backend-factory.js';
      import localBackend from './js/store/backend-localstorage.js';
      import sqljsBackend from './js/store/backend-sqljs.js';
      import supabaseBackend from './js/store/backend-supabase.js';

      registerBackend(localBackend.name, localBackend);
      registerBackend(sqljsBackend.name, sqljsBackend);
      registerBackend(supabaseBackend.name, supabaseBackend);
    </script>
  </body>
</html>
