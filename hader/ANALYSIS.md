# تقرير مراجعة الكود

## ملخص سريع
- التطبيق يعمل بنظامي تشغيل (سحابي/محلي) لكن الإعداد الافتراضي يختار الوضع المحلي، مما يجعل معظم الميزات تعتمد على بيانات LocalStorage بدلاً من Supabase.
- التوجيه مبني على `HashRouter` مع حماية للأدوار داخل الصفحات، ويتم حقن الإشعارات وتشغيل الصوت مباشرة في `App.tsx`.
- طبقة البيانات `services/db.ts` توفر مزودين (سحابي ومحلي) مع واجهة موحدة، بينما المصادقة في `services/auth.ts` تضيف جلسة المستخدم إلى `localStorage`.

## ملاحظات تقنية وأخطاء محتملة
1) **افتراضي دائم للوضع المحلي**
   - `Database` يقرأ وضع التشغيل من LocalStorage ويضبط القيمة الافتراضية على `local`، ما يعني أن أي بيئة جديدة ستعمل كمحاكٍ محلي ما لم يغيَّر الوضع يدوياً. ذلك يعطّل المسار السحابي فعلياً ويخفي أي أعطال في Supabase خلال التجارب الأولية.
   - الأدلة: تهيئة `mode` في الباني مع القيمة الاحتياطية `local`. 【F:services/db.ts†L915-L939】

2) **مفاتيح Supabase وهمية**
   - ملف `supabase.ts` يضع عناوين ومفاتيح افتراضية (`https://xyz.supabase.co` و`public-anon-key`). عند تفعيل الوضع السحابي ستفشل كل العمليات دون رسالة إعداد واضحة، لأن الاتصال سيحاول ضد نطاق غير صالح.
   - الأدلة: تعريف متغيرات البيئة مع القيم الافتراضية الوهمية. 【F:services/supabase.ts†L1-L12】

3) **تسريب إشعارات غير موجهة للأولياء**
   - الاشتراك الفوري في الإشعارات يتحقق فقط من دور المستخدم؛ لا توجد فلترة لـ`target_id` عند الجمهور `guardian` أو غيره، ما يسمح لكل ولي أمر باستقبال كل إشعارات الأولياء حتى لو كانت تخص طالباً آخر.
   - الأدلة: منطق `subscribeToNotifications` لا يفحص `target_id` للجمهور guardian. 【F:services/db.ts†L339-L361】

4) **بيانات اعتماد صريحة ومسجَّلة بلا تشفير**
   - `auth.login` يقارن كلمات المرور مباشرة مع الحقول المخزّنة محلياً (ومن جدول المستخدمين في Supabase) ويخزن الحساب في `localStorage` بلا تشفير. كما توجد بيانات دخول ثابتة (`admin123`, `tech123`) تستخدم كباب خلفي.
   - الأدلة: التحقق من كلمات المرور الصريحة والحسابات الافتراضية. 【F:services/auth.ts†L34-L100】

5) **اشتراك الإشعارات في الواجهة يكدس الصوت ويزيد العدّاد بلا حد**
   - عند وصول كل إشعار يتم تشغيل صوت دون كتم عند الفشل، كما يتم زيادة `unreadCount` من دون سقف أو منطق أرشفة، ما قد يسبب تجربة مزعجة وانخفاض أداء على المدى الطويل.
   - الأدلة: منطق الاشتراك في `App.tsx` يضيف الإشعار ويزيد العدّاد مباشرة. 【F:App.tsx†L22-L68】

## أين نحن في خارطة الطريق
- **الأساس موجود**: التوجيه، الأدوار، طبقة البيانات المزدوجة، ولوحة الإدارة/المتابعة جاهزة مبدئياً.
- **الوضع السحابي غير مُفَعَّل افتراضياً**: يجب الانتقال من نمط "التجريب المحلي" إلى تشغيل Supabase فعلي لاختبار السيناريوهات الحقيقية (حضور، إشعارات، تقارير).
- **الأمن والخصوصية**: يلزم إزالة بيانات الدخول الثابتة، وتجزئة كلمات المرور، وتقييد الإشعارات بحسب المستلم الفعلي قبل إطلاق بيئة إنتاج.
- **قابلية التشغيل في الإنتاج**: يحتاج التطبيق إلى ضبط مفاتيح البيئة، رسائل تحذير واضحة عند فشل الاتصال، وسقف منطقي لعداد الإشعارات/الصوتيات لضمان استقرار التجربة.

## توصيات سريعة للخطوة التالية
- إضافة شاشة إعداد لاختيار الوضع (محلي/سحابي) مع تنبيه إذا كانت مفاتيح Supabase مفقودة.
- تحديث اشتراك الإشعارات ليقارن `target_id` بالمستخدم أو طلابه، مع سياسة تجميع/تصفير للعداد.
- إلغاء البيانات الافتراضية للحسابات، واستخدام تخزين آمن لكلمات المرور في الطرف السحابي أو على الأقل إخفائها في الوضع المحلي.
- تشغيل بناء الإنتاج (`npm run build`) في CI للتقاط أخطاء TypeScript مبكراً.
