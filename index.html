<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="classic">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>حاضر | بوابة الانطلاق</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="css/tokens.css" />
    <link rel="stylesheet" href="css/index.css" />
  </head>
  <body>
    <div class="page-root">
      <main class="landing-shell">
      <section class="hero-pane">
        <div class="hero-content">
          <span class="hero-pill">بوابة الانضباط المدرسي</span>
          <p class="hero-school" data-school-name hidden></p>
          <h1 class="hero-title">مرحبًا بك في «حاضر»</h1>
          <p class="hero-description">
            منصة حضور تعمل بالكامل من المتصفح لتخدم الطلاب، المشرفين، والإدارة.
            ندير الحضور، الرسائل، وسياسات PIN من مكان واحد قابل للتوسع.
          </p>
        </div>
        <p class="hero-tip" data-general-tip>
          <span>✨</span>
          <span>الانضباط يرفع مقامك — احضر بدري وكن قدوة.</span>
        </p>
      </section>
      <section class="actions-pane">
        <header class="actions-header">
          <h2>اختر وجهتك</h2>
          <p>تنتقل كل فئة لواجهتها المخصصة. تذكّر أن الطلاب يدخلون مباشرة دائمًا.</p>
        </header>
        <div class="actions-grid">
          <button class="access-card" data-role="student" type="button">
            <div class="access-card__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 4.5L20.5 9 12 13.5 3.5 9 12 4.5z"></path>
                <path d="M6 11.2v2.6c0 2.6 2.9 4.7 6 4.7s6-2.1 6-4.7v-2.6"></path>
                <path d="M12 13.5V18"></path>
              </svg>
            </div>
            <div class="access-card__content">
              <h3 class="access-card__title">بوابة الحضور</h3>
              <p class="access-card__note">دخول مباشر للبوابة دون الحاجة إلى PIN.</p>
            </div>
          </button>
          <button class="access-card" data-role="leave" type="button">
            <div class="access-card__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 4h6" opacity="0.9"></path>
                <path d="M8 4h8a2 2 0 012 2v12a2 2 0 01-2 2H8a2 2 0 01-2-2V6a2 2 0 012-2z"></path>
                <path d="M9 11l2.2 2.2L15 9.5"></path>
              </svg>
            </div>
            <div class="access-card__content">
              <h3 class="access-card__title">بوابة الإشراف</h3>
              <p class="access-card__note">إدارة الإشراف على الحضور وتحديث تقارير المتابعة.</p>
            </div>
          </button>
          <button class="access-card" data-role="parents" type="button">
            <div class="access-card__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="9" cy="9" r="3.2"></circle>
                <circle cx="17" cy="10.5" r="2.7"></circle>
                <path d="M4.5 19.5c0-3 2.7-5.5 4.5-5.5s4.5 2.5 4.5 5.5"></path>
                <path d="M13.5 19.5c0-2.2 1.9-4 3.5-4s3.5 1.8 3.5 4"></path>
              </svg>
            </div>
            <div class="access-card__content">
              <h3 class="access-card__title">أوليآء الأمور</h3>
              <p class="access-card__note">مجمدة حاليًا — جاري التطوير وإطلاق أدوات المتابعة قريبًا.</p>
            </div>
          </button>
          <button class="access-card" data-role="supervisor" type="button">
            <div class="access-card__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 3l7 3v5.6c0 4.7-3.1 8.9-7 10.4-3.9-1.5-7-5.7-7-10.4V6z"></path>
                <path d="M9.5 12.5l2.2 2.2 3.8-4.3"></path>
              </svg>
            </div>
            <div class="access-card__content">
              <h3 class="access-card__title">لوحة المراقبة</h3>
              <p class="access-card__note" data-pin-note="supervisor">سيتم التحقق من PIN عند الحاجة.</p>
            </div>
          </button>
          <button class="access-card" data-role="admin" type="button">
            <div class="access-card__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 15.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7z"></path>
                <path d="M19.4 9.6l1.1-1.9-2.2-2.2-1.9 1.1a6.9 6.9 0 00-2.4-1.1L13.5 2h-3l-0.5 3.5a6.9 6.9 0 00-2.4 1.1L5.7 5.5 3.5 7.7l1.1 1.9a6.6 6.6 0 000 2.8l-1.1 1.9 2.2 2.2 1.9-1.1a6.9 6.9 0 002.4 1.1L10.5 22h3l0.5-3.5a6.9 6.9 0 002.4-1.1l1.9 1.1 2.2-2.2-1.1-1.9a6.6 6.6 0 000-2.8z"></path>
              </svg>
            </div>
            <div class="access-card__content">
              <h3 class="access-card__title">لوحة الإدارة</h3>
              <p class="access-card__note" data-pin-note="admin">سيتم التحقق من PIN عند الحاجة.</p>
            </div>
          </button>
        </div>
        <p class="footer-hint">
          تعمل «حاضر» دون خوادم. يتم تخزين البيانات محليًا مع مزامنة ذكية بين التبويبات.
        </p>
      </section>
      </main>
      <footer class="site-footer" role="contentinfo">© جميع الحقوق محفوظة | أ. هيثم الزهراني | Him.Art</footer>
    </div>

    <aside class="session-hub" data-session-hub hidden>
      <div class="session-hub__header">
        <div class="session-hub__status">
          <span class="session-hub__dot" aria-hidden="true"></span>
          <span data-session-role>لم يتم تسجيل الدخول</span>
        </div>
        <button class="session-hub__logout" type="button" data-session-logout>تسجيل الخروج</button>
      </div>
      <p class="session-hub__message" data-session-message></p>
      <div class="session-hub__actions">
        <button class="session-hub__action" type="button" data-role-admin hidden>الانتقال إلى إدارة المدرسة</button>
        <button class="session-hub__action" type="button" data-role-supervisor hidden>الانتقال إلى بوابة الإشراف</button>
        <button class="session-hub__action" type="button" data-role-kiosk hidden>فتح الكشك</button>
      </div>
    </aside>

    <section class="support-panel" data-support-panel hidden aria-label="لوحة دعم وإدارة المدارس">
      <header class="support-panel__header">
        <div>
          <h2 class="support-panel__title">لوحة الدعم</h2>
          <p class="support-panel__subtitle">إدارة المدارس والإشارات المضيئة</p>
        </div>
        <div class="support-panel__actions">
          <button class="support-panel__action" type="button" data-support-refresh>تحديث القائمة</button>
          <button class="support-panel__action" type="button" data-support-new>مدرسة جديدة</button>
        </div>
      </header>
      <div class="support-panel__body">
        <div class="support-panel__table">
          <table class="support-table">
            <thead>
              <tr>
                <th scope="col">المدرسة</th>
                <th scope="col">المنطقة الزمنية</th>
                <th scope="col">الحالة</th>
                <th scope="col">الإشارة</th>
                <th scope="col">إجراءات</th>
              </tr>
            </thead>
            <tbody data-support-schools-body>
              <tr data-support-empty>
                <td colspan="5">لا توجد مدارس مسجلة بعد.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <form class="support-form" data-support-form novalidate>
          <h3 class="support-form__title" data-support-form-title>إضافة مدرسة جديدة</h3>
          <input type="hidden" name="original_id" data-support-original-id />
          <div class="support-form__grid">
            <label class="support-form__field">
              <span>المعرّف (ID)</span>
              <input name="id" type="text" required data-support-id />
            </label>
            <label class="support-form__field">
              <span>الاسم الداخلي</span>
              <input name="name" type="text" required data-support-name />
            </label>
            <label class="support-form__field support-form__field--wide">
              <span>الاسم الظاهر</span>
              <input name="display_name" type="text" required data-support-display />
            </label>
            <label class="support-form__field">
              <span>المنطقة الزمنية</span>
              <input name="timezone" type="text" value="Asia/Riyadh" data-support-timezone />
            </label>
            <label class="support-form__field">
              <span>الحالة</span>
              <select name="enabled" data-support-enabled>
                <option value="true">مفعّلة</option>
                <option value="false">موقوفة</option>
              </select>
            </label>
            <label class="support-form__field support-form__field--wide">
              <span>رسالة الإيقاف (تظهر عند تعطيل المدرسة)</span>
              <textarea
                name="disabled_message"
                rows="2"
                data-support-disabled-message
                placeholder="راجع الدعم الفني"
              ></textarea>
            </label>
            <label class="support-form__field" data-support-backend-field>
              <span>إشارة مضيئة</span>
              <select name="data_backend" data-support-backend>
                <option value="localstorage">LocalStorage</option>
                <option value="sqljs">SQL.js (داخل المتصفح)</option>
                <option value="supabase">Supabase</option>
                <option value="rest">REST (موقعنا)</option>
                <option value="other">مزود آخر (سنضبطه يدويًا)</option>
              </select>
            </label>
            <div class="support-form__field support-form__field--stack" data-support-other-fields hidden>
              <label>
                رابط الخدمة (API)
                <input name="other_api_base" type="url" placeholder="https://example.com/api" />
              </label>
              <label>
                رمز الوصول (Token)
                <input name="other_token" type="text" autocomplete="off" />
              </label>
              <label>
                ملاحظات إضافية
                <textarea name="other_note" rows="2"></textarea>
              </label>
            </div>
          </div>
          <div class="support-form__footer">
            <div class="support-form__status" data-support-status aria-live="polite"></div>
            <div class="support-form__actions">
              <button class="support-form__submit" type="submit" data-support-save>حفظ المدرسة</button>
              <button class="support-form__cancel" type="button" data-support-cancel>إلغاء</button>
            </div>
          </div>
        </form>
      </div>
      <footer class="support-panel__footer">
        <p>التحكم في الإشارة المضيئة يؤثر على جميع الواجهات (الإدارة، الإشراف، الكشك). يظهر هذا اللوح فقط للدعم ومسؤولي الموقع.</p>
      </footer>
    </section>

    <button class="login-fab" type="button" data-login-open>
      <span class="login-fab__label" data-login-label>دخول</span>
    </button>

    <div class="login-modal" data-login-modal hidden aria-hidden="true">
      <div class="login-modal__backdrop" data-login-dismiss></div>
      <div class="login-sheet" role="dialog" aria-modal="true" aria-labelledby="login-modal-title">
        <header class="login-sheet__header">
          <h3 class="login-sheet__title" id="login-modal-title">الدخول إلى «حاضر»</h3>
          <button class="login-sheet__close" type="button" data-login-cancel aria-label="إغلاق">×</button>
        </header>
        <form class="login-form" data-login-form novalidate>
          <fieldset class="login-form__methods">
            <legend>طريقة التحقق</legend>
            <label>
              <input type="radio" name="provider" value="local" checked />
              Local (تجربة)
            </label>
            <label>
              <input type="radio" name="provider" value="rest" />
              REST (الخادم الرئيسي)
            </label>
            <label>
              <input type="radio" name="provider" value="supabase" />
              Supabase
            </label>
          </fieldset>

          <label class="login-form__field">
            البريد أو المعرّف
            <input name="username" type="text" autocomplete="username" required />
          </label>

          <label class="login-form__field">
            كلمة المرور أو PIN
            <input name="password" type="password" autocomplete="current-password" required />
          </label>

          <label class="login-form__field">
            اختر الدور
            <select name="role" required>
              <option value="site_admin">site_admin</option>
              <option value="support">support</option>
              <option value="school_admin">school_admin</option>
              <option value="supervisor_general">supervisor_general</option>
              <option value="supervisor_class">supervisor_class</option>
              <option value="kiosk_view">kiosk_view</option>
            </select>
          </label>

          <label class="login-form__field" data-school-group hidden>
            رقم المدرسة (school_id)
            <input name="school_id" type="text" inputmode="numeric" autocomplete="one-time-code" />
          </label>

          <label class="login-form__checkbox">
            <input type="checkbox" name="remember" checked />
            تذكرني على هذا الجهاز
          </label>

          <p class="login-form__note" data-backend-note>وضع Local مناسب للتجارب. تأكد من تفعيل REST عند النشر.</p>

          <div class="login-form__error" data-login-error role="alert" hidden></div>

          <div class="login-form__actions">
            <button class="login-form__submit" type="submit" data-login-submit>دخول</button>
            <button class="login-form__cancel" type="button" data-login-cancel>إلغاء</button>
          </div>
        </form>
      </div>
    </div>

    <div class="toast-stack" data-toast-stack></div>

    <div class="pin-modal" data-pin-modal aria-hidden="true" role="dialog" aria-modal="true">
      <div class="pin-sheet" role="document">
        <div class="pin-sheet__header">
          <h3 data-pin-title>التحقق من PIN</h3>
          <button class="pin-sheet__close" type="button" data-pin-cancel aria-label="إغلاق">×</button>
        </div>
        <form data-pin-form>
          <label>
            أدخل PIN للوصول
            <input name="pin" type="password" inputmode="numeric" autocomplete="one-time-code" required maxlength="12" />
          </label>
          <div class="pin-sheet__message" data-pin-message></div>
          <div class="pin-sheet__actions">
            <button class="pin-sheet__submit" type="submit" data-pin-submit>تأكيد</button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="./js/env.js"></script>
    <script type="module">
      import { setSession, clearSession } from "./js/env.js";

      window.HaderSupabase = {
        async login({ email, password }) {
          if (!window.sb) throw new Error("Supabase غير مهيأ");
          const { data, error } = await window.sb.auth.signInWithPassword({ email, password });
          if (error) throw error;

          const user = data.user;
          const meta = user?.user_metadata || {};
          const session = {
            sub: user.id,
            email: user.email,
            role: meta.hader_role || "viewer",
            school_id: meta.school_id || null,
            at: Date.now()
          };
          setSession(session);
          return session;
        },
        async logout() {
          if (window.sb) await window.sb.auth.signOut();
          clearSession();
        }
      };

      // مثال ربط بسيط مع نموذج الدخول الحالي:
      // document.querySelector('[data-login-form]')?.addEventListener('submit', async (e) => { ... })
    </script>
    <script src="js/school-config.js"></script>
    <script src="js/force-login.js"></script>
    <script src="js/app.js"></script>
    <script type="module" src="js/store/backend-factory.js"></script>
    <script type="module" src="js/backend-otherrest.js"></script>
    <script type="module" src="js/backend-supabase.js"></script>
    <script type="module" src="js/theme-utils.js"></script>
    <script type="module" src="js/index.js"></script>
    <script type="module" src="js/index-support.js"></script>
    <script type="module" src="js/index-login.js"></script>
    <script type="module">
      import { registerBackend } from './js/store/backend-factory.js';
      import localBackend from './js/store/backend-localstorage.js';
      import sqljsBackend from './js/store/backend-sqljs.js';
      import supabaseBackend from './js/store/backend-supabase.js';

      registerBackend(localBackend.name, localBackend);
      registerBackend(sqljsBackend.name, sqljsBackend);
      registerBackend(supabaseBackend.name, supabaseBackend);
    </script>
  </body>
</html>
